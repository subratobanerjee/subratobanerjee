date_config:
  mode: "range"
  from_date: "2000-01-01"
  to_date: "2099-12-31"
  date_column: "first_seen"

datasets:
  - name: mobile{env}.managed.master_id_map

    checks:

      # 1) Base health
      - name: row_count

      # 2) Nulls on essential identity fields
      - name: null_check
        columns: [id_type, id, master_id, first_seen]

      # 3) Uniqueness of each ID within its type
      - name: duplicate
        columns: [id_type, id]

      # 4) Stability of master_id mapping (id_type='acct_id')
      - name: custom_sql
        sql: |
          WITH acct AS (
            SELECT COUNT(*) AS total_accts,
                   SUM(
                     CASE WHEN master_id IS NULL THEN 1 ELSE 0 END
                   ) AS null_master_ids
            FROM mobile{env}.managed.master_id_map
            WHERE id_type = 'acct_id'
              AND TO_DATE(first_seen) = CURRENT_DATE()
          )
          SELECT
            (null_master_ids::float / NULLIF(total_accts,0)) AS metric
          FROM acct
        warn: "when > 0.01"
        fail: "when > 0.05"

      # 5) Optional: Detect unusual re-mapping rates (changed degree / changed components)
      - name: custom_sql
        sql: |
          WITH recent AS (
            SELECT *
            FROM mobile{env}.managed.master_id_map
            WHERE TO_DATE(first_seen) >= CURRENT_DATE() - 1
          ),
          stats AS (
            SELECT COUNT(*) AS total_rows,
                   SUM(CASE WHEN degree IS NULL THEN 1 ELSE 0 END) AS missing_degree
            FROM recent
          )
          SELECT
            (missing_degree::float / NULLIF(total_rows,0)) AS metric
          FROM stats
        warn: "when > 0.05"
        fail: "when > 0.15"

threshold_percent: 0
warn_percentage: 0.05
fail_percentage: 0.15
