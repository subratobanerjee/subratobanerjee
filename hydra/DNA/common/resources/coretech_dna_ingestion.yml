resources:
  jobs:
    coretech_dna_ingestion:
      name: coretech_dna_ingestion
      max_concurrent_runs: 1

      continuous:
        pause_status: ${var.schedule_status}
        task_retry_mode: ON_FAILURE

      webhook_notifications:
        on_failure:
          - id: ${var.slack_webhook}

      tasks:
        - task_key: sso_raw_ingest
          job_cluster_key: coretech_dna_ingestion${var.environment}
          python_wheel_task:
            package_name: common
            entry_point: stream_raw_ingest
            parameters:
              - --environment
              - ${var.environment}
              - --checkpoint_location
              - dbfs:/tmp/coretech/sso/run${var.environment}
              - --bootstrap_servers
              - pkc-3nrx70.us-east-1.aws.confluent.cloud:9092
              - --title
              - coretech
              - --topics
              - telemetry.events.read.internal.sso.1,telemetry.events.read.internal.subscription.1
          
          libraries:
            - whl: /Workspace/Users/${workspace.current_user.userName}/${bundle.name}/${bundle.target}/artifacts/.internal/${var.wheel_name}-0.6-py3-none-any.whl 
        
        - task_key: ecommerce_raw_ingest
          job_cluster_key: coretech_dna_ingestion${var.environment}
          python_wheel_task:
            package_name: common
            entry_point: stream_raw_ingest
            parameters:
              - --environment
              - ${var.environment}
              - --checkpoint_location
              - dbfs:/tmp/coretech/sso/ecommerce/run${var.environment}
              - --bootstrap_servers
              - pkc-3nrx70.us-east-1.aws.confluent.cloud:9092
              - --title
              - ecommerce
              - --topics
              - telemetry.events.read.internal.commerce.codes.1,telemetry.events.read.internal.commerce.entitlements.1,telemetry.events.read.internal.commerce.inventory.1,telemetry.events.read.internal.commerce.purchase.1,telemetry.events.read.internal.commerce.wallet.1

          
          libraries:
            - whl: /Workspace/Users/${workspace.current_user.userName}/${bundle.name}/${bundle.target}/artifacts/.internal/${var.wheel_name}-0.6-py3-none-any.whl 

        - task_key: ecommerce_v3_raw_ingest
          job_cluster_key: coretech_dna_ingestion${var.environment}
          python_wheel_task:
            package_name: common
            entry_point: stream_raw_ingest
            parameters:
              - --environment
              - ${var.environment}
              - --checkpoint_location
              - dbfs:/tmp/coretech/sso/ecommerce/v3/run${var.environment}
              - --bootstrap_servers
              - pkc-3nrx70.us-east-1.aws.confluent.cloud:9092
              - --title
              - ecommerce
              - --starting_offsets
              - earliest
              - --topics
              - telemetry.events.read.internal.commerce.transactions.1,telemetry.events.read.internal.commerce.vouchers.1

          libraries:
            - whl: /Workspace/Users/${workspace.current_user.userName}/${bundle.name}/${bundle.target}/artifacts/.internal/${var.wheel_name}-0.6-py3-none-any.whl 

        # - task_key: web_raw_ingest
        #   job_cluster_key: coretech_dna_ingestion${var.environment}
        #   python_wheel_task:
        #     package_name: common
        #     entry_point: stream_raw_ingest
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/coretech/sso/web/run${var.environment}
        #       - --bootstrap_servers
        #       - pkc-1jv6v.us-east-1.aws.confluent.cloud:9092
        #       - --title
        #       - coretech
        #       - --topics
        #       - telemetry.events.read.good.035fbed4eda54ebb8a4fd2522e049308.1,telemetry.events.read.good.c4fa75ad36654a509fd4a4297de18595.1
          
        #   libraries:
        #     - whl: /Workspace/Users/${workspace.current_user.userName}/${bundle.name}/${bundle.target}/artifacts/.internal/${var.wheel_name}-0.6-py3-none-any.whl 

      job_clusters:
        - job_cluster_key: coretech_dna_ingestion${var.environment}
          new_cluster:
            spark_version: 16.0.x-scala2.12
            data_security_mode: SINGLE_USER
            aws_attributes:
              availability: ON_DEMAND
            node_type_id: ${var.node_type_id}
            driver_node_type_id: ${var.driver_node_type_id}
            num_workers: ${var.num_workers}
            init_scripts:
              - workspace:
                  destination: /Shared/datadog/dd_init.sh
            spark_conf:
              'spark.driver.extraJavaOptions': '-XX:+UseZGC'
            spark_env_vars:
              DD_API_KEY: "{{secrets/data-engineering/dd_api_key}}"
            custom_tags:
              owner: "Data Engineering"
      
      tags:
        business_unit: "Coretech DNA"
        data_layer: "raw"
        environment: ${var.environment}
        owner: "Data Engineering"
      
      permissions:
        - level: CAN_MANAGE
          group_name: "dna live"
        - level: CAN_MANAGE
          group_name: "data engineering"