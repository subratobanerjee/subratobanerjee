# The main job for batch managed.
resources:
  jobs:
    coretech_managed_hourly:
      name: coretech_managed_hourly
      max_concurrent_runs: 1

      webhook_notifications:
        on_failure:
          - id: ${var.slack_webhook}

      schedule:
        quartz_cron_expression: 0 0 4 1/1 * ? *
        timezone_id: UTC
        pause_status: ${var.schedule_status}

      tasks:
        - task_key: fact_player_code_redemption
          job_cluster_key: coretech_managed_batch_cluster${var.environment}
          python_wheel_task:
            package_name: common
            entry_point: fact_player_code_redemption
            parameters:
              - --environment
              - ${var.environment}
          webhook_notifications:
            on_failure:
              - id: ${var.slack_webhook}
          libraries:
            - whl: /Workspace/Users/${workspace.current_user.userName}/${bundle.name}/${bundle.target}/artifacts/.internal/${var.wheel_name}-0.6-py3-none-any.whl

      job_clusters:
        - job_cluster_key: coretech_managed_batch_cluster${var.environment}
          new_cluster:
            spark_version: 16.4.x-scala2.12
            aws_attributes:
              availability: ON_DEMAND
            node_type_id: m7gd.2xlarge
            driver_node_type_id: m7gd.2xlarge
            autoscale:
              min_workers: 1
              max_workers: 3
            init_scripts:
              - workspace:
                  destination: /Shared/datadog/dd_init.sh
            spark_conf:
              'spark.driver.extraJavaOptions': '-XX:+UseZGC'
            spark_env_vars:
              DD_API_KEY: "{{secrets/data-engineering/dd_api_key}}"
            custom_tags:
              owner: "Data Engineering"
      
      tags:
        business_unit: "Core Games"
        data_layer: "raw"
        environment: ${var.environment}
        owner: "Data Engineering"
      
      permissions:
        - level: CAN_MANAGE
          group_name: "dna live"
        - level: CAN_MANAGE
          group_name: "data engineering"