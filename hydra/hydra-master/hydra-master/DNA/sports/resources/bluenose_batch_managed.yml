# The main job for batch managed.
resources:
  jobs:
    bluenose_managed_daily:
      name: bluenose_managed_daily
      max_concurrent_runs: 1

      webhook_notifications:
        on_failure:
          - id: ${var.slack_webhook}

      schedule:
        quartz_cron_expression: 0 0 0/6 ? * * *
        timezone_id: UTC
        pause_status: ${var.schedule_status}

      tasks:
        - task_key: fact_player_activity
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/streaming/intermediate/fact_player_activity.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'

        - task_key: fact_player_session
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/streaming/intermediate/fact_player_session.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'

        - task_key: fact_player_transaction
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/streaming/intermediate/fact_player_transaction.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_summary_ltd

        - task_key: fact_player_entitlement
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/streaming/intermediate/fact_player_entitlement.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'

        - task_key: fact_player_summary_ltd
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/streaming/managed/fact_player_summary_ltd.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'

        - task_key: fact_player_igo
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/streaming/intermediate/fact_player_igo.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'

        - task_key: fact_player_lesson
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/streaming/managed/fact_player_lesson.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'

        - task_key: fact_player_progression
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/intermediate/fact_player_progression.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_session

        - task_key: fact_player_equipment_progression
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_equipment_progression.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
      
        - task_key: fact_player_game_settings
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_game_settings.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'

        - task_key: fact_player_igo_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_igo_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_igo

        - task_key: fact_player_igc_earn_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_igc_earn_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_transaction

        - task_key: agg_igc_earn_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_igc_earn_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_igc_earn_daily

        - task_key: fact_player_game_status_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_game_status_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_activity

        - task_key: agg_game_status_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_game_status_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'    

        - task_key: fact_player_ftue
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_ftue.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_progression

        - task_key: fact_myplayer_progression_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_myplayer_progression_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_progression

        - task_key: fact_myplayer_subject_progression_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_myplayer_subject_progression_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}' 
          depends_on:
            - task_key: fact_player_progression 

        - task_key: fact_player_igm_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_igm_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
        
        - task_key: fact_link_activity
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_link_activity.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_activity 

        - task_key: agg_link_activity_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_link_activity_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_link_activity      

        - task_key: agg_myplayer_progression_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_myplayer_progression_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_myplayer_progression_daily      

        - task_key: agg_subject_progression_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_subject_progression_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_myplayer_subject_progression_daily                

        - task_key: agg_igo_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_igo_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}' 
          depends_on:
            - task_key: fact_player_igo_daily


        - task_key: agg_ftue_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_ftue_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}' 
          depends_on:
            - task_key: fact_player_ftue

        - task_key: agg_igm_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_igm_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}' 
          depends_on:
            - task_key: fact_player_igm_daily

        - task_key: agg_game_settings_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_game_settings_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_game_settings                                                          

        - task_key: fact_player_item_igc_spend_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_item_igc_spend_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_transaction                                 

        - task_key: agg_item_igc_spend_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_item_igc_spend_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'                                                

        - task_key: fact_player_igc_purchase_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_igc_purchase_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'   
          depends_on:
            - task_key: fact_player_transaction                                                  

        - task_key: agg_igc_purchase_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/agg_igc_purchase_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_igc_purchase_daily                                                       

        - task_key: fact_player_session_daily
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_session_daily.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
          depends_on:
            - task_key: fact_player_session    

        - task_key: fact_player_seasonpass_purchase
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../bluenose/src/batch/managed/fact_player_seasonpass_purchase.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'

        - task_key: snowflake_refresh_managed
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../../utils/src/snowflake/refresh_snowflake_iceberg_tables.py
            base_parameters:
              environment: ${var.environment}
              title: bluenose
              dbx_catalog: bluenose${var.environment}
              dbx_schema: managed
          depends_on:
            - task_key: agg_link_activity_daily
            - task_key: agg_igo_daily
            - task_key: agg_myplayer_progression_daily
            - task_key: agg_subject_progression_daily
            - task_key: agg_ftue_daily
            - task_key: agg_igc_earn_daily
            - task_key: agg_igc_purchase_daily

        - task_key: snowflake_refresh_intermediate
          job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          notebook_task:
            notebook_path: ../../utils/src/snowflake/refresh_snowflake_iceberg_tables.py
            base_parameters:
              environment: ${var.environment}
              title: bluenose
              dbx_catalog: bluenose${var.environment}
              dbx_schema: intermediate
          depends_on:
            - task_key: fact_player_activity
            - task_key: fact_player_transaction



      # The managed cluster will use memory-optimized instances due to having to store state in memory
      job_clusters:
        - job_cluster_key: bluenose_managed_batch_cluster${var.environment}
          new_cluster:
            spark_version: 16.4.x-scala2.12
            data_security_mode: SINGLE_USER
            aws_attributes:
              availability: ON_DEMAND
            node_type_id: ${var.node_type_id}
            driver_node_type_id: ${var.driver_node_type_id}
            num_workers: ${var.num_workers}
            init_scripts:
              - workspace: 
                  destination: /Shared/datadog/dd_init.sh
            spark_conf:
              'spark.driver.extraJavaOptions': '-XX:+UseZGC'
            spark_env_vars:
              DD_API_KEY: "{{secrets/data-engineering/dd_api_key}}"
            custom_tags:
              owner: "Data Engineering"
            cluster_log_conf:
              dbfs:
                destination: dbfs:/cluster-logs
      
      tags:
        business_unit: "Sports"
        title: "bluenose"
        catalog: "bluenose${var.environment}"
        data_layer: "managed"
        environment: ${var.environment}

      permissions:
        - level: CAN_MANAGE
          group_name: "dna live"
        - level: CAN_MANAGE
          group_name: "data engineering"