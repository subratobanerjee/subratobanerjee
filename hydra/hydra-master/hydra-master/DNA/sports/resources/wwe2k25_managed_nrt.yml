# The main job for raw.
resources:
  jobs:
    wwe2k25_managed_nrt:
      name: wwe2k25_managed_nrt
      max_concurrent_runs: 1

      continuous:
        pause_status: ${var.schedule_status}
        task_retry_mode: ON_FAILURE

      webhook_notifications:
        on_failure:
          - id: ${var.slack_webhook}

      tasks:
        # - task_key: fact_player_transaction
          # job_cluster_key: wwe2k25_streaming${var.environment}
          # notebook_task:
          #   notebook_path: ../wwe/wwe2k25/src/streaming/intermediate/fact_player_transaction.py
          #   base_parameters:
          #     inputParam: '{"environment":"${var.environment}"}'
          #     checkpoint: 'dbfs:/tmp/wwe/wwe2k25/intermediate/streaming/run${var.environment}/fact_player_transaction'
          # webhook_notifications:
          #   on_failure:
          #     - id: ${var.slack_webhook}

        - task_key: fact_player_activity
          job_cluster_key: wwe2k25_streaming${var.environment}
          notebook_task:
            notebook_path: ../wwe/wwe2k25/src/streaming/intermediate/fact_player_activity.py
            base_parameters:
              inputParam: '{"environment":"${var.environment}"}'
              checkpoint: 'dbfs:/tmp/wwe/wwe2k25/intermediate/streaming/run${var.environment}/fact_player_activity'
          webhook_notifications:
            on_failure:
              - id: ${var.slack_webhook}

        # - task_key: fact_player_summary_ltd
        #   job_cluster_key: wwe2k25_streaming${var.environment}
        #   notebook_task:
        #     notebook_path: ../wwe/wwe2k25/src/streaming/managed/fact_player_summary_ltd.py
        #     base_parameters:
        #       inputParam: '{"environment":"${var.environment}"}'
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}

        # - task_key: agg_game_status_nrt
        #   job_cluster_key: wwe2k25_streaming${var.environment}
        #   notebook_task:
        #     notebook_path: ../wwe/wwe2k25/src/streaming/managed/agg_game_status_nrt.py
        #     base_parameters:
        #       inputParam: '{"environment":"${var.environment}"}'
        #       checkpoint: 'dbfs:/tmp/wwe2k25/managed/streaming/run${var.environment}/agg_game_status_nrt'
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}

        # - task_key: agg_logins_nrt
        #   job_cluster_key: wwe2k25_streaming${var.environment}
        #   notebook_task:
        #     notebook_path: ../wwe/wwe2k25/src/streaming/managed/agg_logins_nrt.py
        #     base_parameters:
        #       inputParam: '{"environment":"${var.environment}"}'
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}

        # - task_key: agg_installs_nrt
        #   job_cluster_key: wwe2k25_streaming${var.environment}
        #   notebook_task:
        #     notebook_path: ../wwe/wwe2k25/src/streaming/managed/agg_installs_nrt.py
        #     base_parameters:
        #       inputParam: '{"environment":"${var.environment}"}'
        #       checkpoint: 'dbfs:/tmp/wwe2k25/managed/streaming/run${var.environment}/agg_installs_nrt'
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}

        # - task_key: fact_player_session
        #   job_cluster_key: wwe2k25_streaming${var.environment}
        #   notebook_task:
        #     notebook_path: ../wwe/wwe2k25/src/streaming/intermediate/fact_player_session.py
        #     base_parameters:
        #       inputParam: '{"environment":"${var.environment}"}'
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}

        # - task_key: agg_vc_purchase_nrt
        #   job_cluster_key: wwe2k25_streaming${var.environment}
        #   notebook_task:
        #     notebook_path: ../wwe/wwe2k25/src/streaming/managed/agg_vc_purchase_nrt.py
        #     base_parameters:
        #       inputParam: '{"environment":"${var.environment}"}'
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}

        # - task_key: fact_player_entitlement
        #   job_cluster_key: wwe2k25_streaming${var.environment}
        #   notebook_task:
        #     notebook_path: ../wwe/wwe2k25/src/streaming/intermediate/fact_player_entitlement.py
        #     base_parameters:
        #       inputParam: '{"environment":"${var.environment}"}'
        #       checkpoint: 'dbfs:/tmp/wwe/wwe2k25/intermediate/streaming/run${var.environment}/fact_player_entitlement'
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}

      job_clusters:
        - job_cluster_key: wwe2k25_streaming${var.environment}
          new_cluster:
            spark_version: 16.4.x-scala2.12
            aws_attributes:
              availability: ON_DEMAND
            node_type_id: ${var.node_type_id}
            driver_node_type_id: ${var.driver_node_type_id}
            num_workers: ${var.num_workers}
            enable_elastic_disk: true
            init_scripts:
              - workspace:
                  destination: /Shared/datadog/dd_init.sh
            spark_conf:
              'spark.driver.extraJavaOptions': '-XX:+UseZGC'
            spark_env_vars:
              DD_API_KEY: "{{secrets/data-engineering/dd_api_key}}"
            custom_tags:
              owner: "Data Engineering"

      tags:
        business_unit: "Sports"
        data_layer: "raw"
        environment: ${var.environment}
        owner: "Data Engineering"

      permissions:
        - level: CAN_MANAGE
          group_name: "dna live"
        - level: CAN_MANAGE
          group_name: "data engineering"