# The main job for raw.
resources:
  jobs:
    horizon_managed_nrt:
      name: horizon_managed_nrt
      max_concurrent_runs: 1

      continuous:
        pause_status: ${var.schedule_status}

      webhook_notifications:
        on_failure:
          - id: ${var.slack_webhook}

      tasks:
        - task_key: fact_player_match_summary
          job_cluster_key: horizon_managed_nrt_cluster${var.environment}
          python_wheel_task:
            package_name: horizon
            entry_point: stream_player_match_summary
            parameters:
              - --environment
              - ${var.environment}
              - --checkpoint_location
              - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/fact_player_match_summary
          webhook_notifications:
            on_failure:
              - id: ${var.slack_webhook}
          libraries:
            - whl: ${var.wheel_path}
        - task_key: fact_player_activity
          job_cluster_key: horizon_managed_nrt_cluster${var.environment}
          python_wheel_task:
            package_name: horizon
            entry_point: stream_player_activity
            parameters:
              - --environment
              - ${var.environment}
              - --checkpoint_location
              - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/fact_player_activity
          webhook_notifications:
            on_failure:
              - id: ${var.slack_webhook}
          libraries:
              - whl: ${var.wheel_path}
        - task_key: fact_down_death
          job_cluster_key: horizon_managed_nrt_cluster${var.environment}
          python_wheel_task:
            package_name: horizon
            entry_point: stream_down_death
            parameters:
              - --environment
              - ${var.environment}
              - --checkpoint_location
              - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/fact_down_death
          webhook_notifications:
            on_failure:
              - id: ${var.slack_webhook}
          libraries:
              - whl: ${var.wheel_path}
        # - task_key: agg_twitch_entitlement_10min
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_agg_twitch_entitlement
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/agg_twitch_entitlement_10min
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}
        #   libraries:
        #       - whl: ${var.wheel_path}
        # - task_key: agg_login_10min
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_agg_login
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/agg_login_10min
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}
        #   libraries:
        #     - whl: ${var.wheel_path}
        # - task_key: agg_subscription_10min
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_agg_subscription
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/agg_subscription_10min
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}
        #   libraries:
        #     - whl: ${var.wheel_path}
 
        # - task_key: agg_emails_sent_10min
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_agg_emails_sent
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/agg_emails_sent_10min
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}
        #   libraries:
        #     - whl: ${var.wheel_path}
        
        # - task_key: agg_party_invite_accept_1hr
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_party_invite_agg
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/agg_party_activity_1hr
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}

        #   libraries:
        #     - whl: ${var.wheel_path}
        # - task_key: agg_match_summary_10min
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: agg_match_summary_10min
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/agg_match_10min
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}
        #   libraries:
        #     - whl: ${var.wheel_path}
        # - task_key: agg_account_create_10min
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_agg_account_create
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/agg_account_create_10min
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}
        #   libraries:
        #     - whl: ${var.wheel_path}
        # - task_key: agg_legal_docs_accepted_10min
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_agg_legal_docs
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/agg_legal_docs_accepted_10min
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}
        #   libraries:
        #     - whl: ${var.wheel_path}
        # - task_key: agg_account_ban_10min
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_agg_account_ban
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/agg_account_ban_10min
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}
        #   libraries:
        #     - whl: ${var.wheel_path}
        # - task_key: agg_install_10_min
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_installs
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/agg_install_10_min
        #   webhook_notifications:
        #     on_failure:
        #       - id: ${var.slack_webhook}
        #   libraries:
        #     - whl: ${var.wheel_path}
        - task_key: fact_player_transactions
          job_cluster_key: horizon_managed_nrt_cluster${var.environment}
          python_wheel_task:
            package_name: horizon
            entry_point: stream_player_transactions
            parameters:
              - --environment
              - ${var.environment}
              - --checkpoint_location
              - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/fact_player_transactions
          webhook_notifications:
            on_failure:
              - id: ${var.slack_webhook}
          libraries:
            - whl: ${var.wheel_path}    
 
        # - task_key: fact_level_up
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_level_up
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/fact_level_up
        #   libraries:
        #     - whl: /Workspace/Users/${workspace.current_user.userName}/${bundle.name}/${bundle.target}/artifacts/.internal/${var.wheel_name}-0.6-py3-none-any.whl 
        
        # - task_key: fact_player_gauntlet_fight_summary
        #   job_cluster_key: horizon_managed_nrt_cluster${var.environment}
        #   python_wheel_task:
        #     package_name: horizon
        #     entry_point: stream_gauntlet_fight_summary
        #     parameters:
        #       - --environment
        #       - ${var.environment}
        #       - --checkpoint_location
        #       - dbfs:/tmp/horizon/managed/streaming/run${var.environment}/fact_player_gauntlet_fight_summary
        #   libraries:
        #     - whl: /Workspace/Users/${workspace.current_user.userName}/${bundle.name}/${bundle.target}/artifacts/.internal/${var.wheel_name}-0.6-py3-none-any.whl 

      # The managed cluster will use memory-optimized instances due to having to store state in memory
      job_clusters:
        - job_cluster_key: horizon_managed_nrt_cluster${var.environment}
          new_cluster:
            spark_version: 15.2.x-scala2.12
            aws_attributes:
              availability: ON_DEMAND
            node_type_id: ${var.node_type_id}
            driver_node_type_id: ${var.driver_node_type_id}
            num_workers: ${var.num_workers}
            init_scripts:
              - workspace: 
                  destination: /Shared/datadog/dd_init.sh
            spark_env_vars:
              DD_API_KEY: "{{secrets/data-engineering/dd_api_key}}"
            custom_tags:
              owner: "Data Engineering"
      
      tags:
        business_unit: "Horizon"
        catalog: "horizon${var.environment}"
        data_layer: "managed"
        environment: ${var.environment}

      permissions:
        - level: CAN_MANAGE
          group_name: "dna live"
        - level: CAN_MANAGE
          group_name: "data engineering"